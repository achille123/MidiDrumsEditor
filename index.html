<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drum Grid Editor</title>
  <style>
    body { font-family: sans-serif; background: #111; color: white; margin: 0; padding: 1rem; }
    #toolbar { margin-bottom: 1rem; }
    .drag-item, #clear-btn {
      display: inline-block;
      background: #333;
      padding: 0.5rem 1rem;
      margin-right: 1rem;
      border-radius: 4px;
      cursor: grab;
    }
    .bar-label-band {
      display: grid;
      grid-template-columns: repeat(8, 80px);
      margin-bottom: 4px;
      height: 20px;
    }
    .bar-label-band div {
      height: 100%;
      line-height: 20px;
      font-size: 0.75rem;
      font-weight: bold;
      text-align: center;
    }
    .bar-label-band div:nth-child(1) {
      grid-column: span 4;
      background: white;
      color: black;
    }
    .bar-label-band div:nth-child(2) {
      grid-column: span 4;
      background: white;
      color: black;
      border-left: 2px solid black;
    }
    .instrument-row { display: flex; align-items: center; margin-bottom: 8px; }
    .label { width: 60px; text-align: right; margin-right: 8px; }
    .grid-row { display: grid; grid-template-columns: repeat(8, 80px); gap: 2px; }
    .cell { width: 80px; height: 80px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
    .cell.active { background: #3ad33a44; }
    .sub-grid { display: flex; justify-content: space-evenly; align-items: center; width: 100%; height: 100%; position: relative; }
    .sub-dot-wrapper { position: relative; height: 100%; display: flex; align-items: center; justify-content: center; }
    .sub-dot-wrapper::before { content: ""; position: absolute; top: 0; bottom: 0; left: 50%; width: 1px; background: white; transform: translateX(-50%); }
    .sub-dot { width: 12px; height: 12px; background-color: white; border-radius: 50%; cursor: ns-resize; position: absolute; top: 34px; }
    .sub-dot.inactive { background-color: grey; }
    .sub-dot.selected { outline: 2px solid red; }
  </style>
</head>
<body>
  <div id="toolbar">
    <div class="drag-item" draggable="true" data-rhythm="1">1/16</div>
    <div class="drag-item" draggable="true" data-rhythm="2">2/16</div>
    <div class="drag-item" draggable="true" data-rhythm="4">4/16</div>
    <div class="drag-item" draggable="true" data-rhythm="3">Triolet</div>
    <div class="drag-item" draggable="true" data-rhythm="6">Sextolet</div>
    <div id="clear-btn">üóëÔ∏è Clear</div>
  </div>
  <div class="bar-label-band">
    <div>Bar 1</div><div>Bar 2</div>
  </div>
  <div id="grid"></div>
  <script>
const instruments = ["Kick", "Snare", "Hi-Hat"];
const steps = 8;
let selectedDots = new Set();
let dKey = false, sKey = false, aKey = false, cmdKey = false;
let draggedRhythm = null;
let mouseDown = false;

document.addEventListener('keydown', e => {
  if (e.key === 'd') dKey = true;
  if (e.key === 's') sKey = true;
  if (e.key === 'a') aKey = true;
  if (e.metaKey || e.ctrlKey) cmdKey = true;
});
document.addEventListener('keyup', e => {
  if (e.key === 'd') dKey = false;
  if (e.key === 's') sKey = false;
  if (e.key === 'a') aKey = false;
  if (!e.metaKey && !e.ctrlKey) cmdKey = false;
});
document.addEventListener('mouseup', () => mouseDown = false);

function createDot(wrapper, index, active = true) {
  const dot = document.createElement("div");
  dot.className = "sub-dot";
  if (!active) dot.classList.add("inactive");
  dot.dataset.index = index;
  dot.style.top = "34px";

  let startY = 0;
  let startTop = 34;

  dot.addEventListener("mousedown", e => {
    startY = e.clientY;
    startTop = parseFloat(dot.style.top);

    const allDots = dot.closest('.cell').querySelectorAll('.sub-dot.selected');
    const isSelected = dot.classList.contains('selected');
    const targets = isSelected ? allDots : [dot];
    const tops = Array.from(targets).map(d => parseFloat(d.style.top));

    const onMouseMove = moveEvent => {
      const delta = moveEvent.clientY - startY;
      targets.forEach((d, i) => {
        const newTop = Math.max(0, Math.min(68, tops[i] + delta));
        d.style.top = `${newTop}px`;
      });
    };

    const onMouseUp = () => {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    };

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  });

  dot.addEventListener("click", e => {
    if (!e.ctrlKey && !e.metaKey) {
      dot.classList.toggle("inactive");
    }
  });

  wrapper.appendChild(dot);
}

function populateCell(cell, rhythm) {
  cell.classList.add("active");
  const subGrid = document.createElement("div");
  subGrid.className = "sub-grid";
  const count = rhythm === 3 ? 3 : rhythm === 6 ? 6 : 4;
  for (let i = 0; i < count; i++) {
    const wrapper = document.createElement("div");
    wrapper.className = "sub-dot-wrapper";
    let active = rhythm === 4;
    if (rhythm === 1) active = i === 0;
    if (rhythm === 2) active = i === 0 || i === 2;
    if (rhythm === 3 || rhythm === 6) active = true;
    createDot(wrapper, i, active);
    subGrid.appendChild(wrapper);
  }
  cell.innerHTML = "";
  cell.appendChild(subGrid);
}

function toggleDots(cell, type) {
  const dots = [...cell.querySelectorAll(".sub-dot")];
  if (type === "a") dots.forEach(dot => dot.classList.remove("inactive"));
  if (type === "d") dots.forEach(dot => dot.classList.add("inactive"));
  if (type === "s") {
    const selected = dots.filter(dot => dot.classList.contains("selected")).length;
    const majority = selected < dots.length / 2;
    dots.forEach(dot => {
      dot.classList.toggle("selected", majority);
      if (majority) selectedDots.add(dot); else selectedDots.delete(dot);
    });
  }
}

function createRow(instrument) {
  const row = document.createElement("div");
  row.className = "instrument-row";
  const label = document.createElement("div");
  label.className = "label";
  label.textContent = instrument;
  row.appendChild(label);

  const gridRow = document.createElement("div");
  gridRow.className = "grid-row";

  for (let i = 0; i < steps; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";

    cell.addEventListener("mousedown", e => {
      mouseDown = true;
      const isAnyModifier = sKey || aKey || dKey || cmdKey;

      // Delete if already active and no modifier is pressed
      if (cell.classList.contains("active") && !isAnyModifier) {
        cell.classList.remove("active");
        cell.innerHTML = "";
        return;
      }

      // Only populate if no modifiers and cell is not active
      if (!cell.classList.contains("active") && !isAnyModifier) {
        populateCell(cell, 1);
        return;
      }

      if (sKey || aKey || dKey) {
        toggleDots(cell, sKey ? "s" : aKey ? "a" : "d");
      } else if (cmdKey) {
        const dots = cell.querySelectorAll(".sub-dot");
        dots.forEach(dot => dot.style.top = "34px");
      }
    });

    cell.addEventListener("mouseenter", () => {
      if (mouseDown && !cell.classList.contains("active") && !sKey && !aKey && !dKey && !cmdKey) {
        populateCell(cell, 1);
      } else if (mouseDown && cell.classList.contains("active") && !sKey && !aKey && !dKey && !cmdKey) {
        cell.classList.remove("active");
        cell.innerHTML = "";
      }
    });

    cell.addEventListener("dblclick", () => {
      const dots = cell.querySelectorAll(".sub-dot");
      dots.forEach(dot => {
        dot.classList.add("selected");
        selectedDots.add(dot);
      });
    });

    cell.addEventListener("dragover", e => e.preventDefault());
    cell.addEventListener("drop", e => {
      if (draggedRhythm) populateCell(cell, parseInt(draggedRhythm));
    });

    gridRow.appendChild(cell);
  }
  row.appendChild(gridRow);
  document.getElementById("grid").appendChild(row);
}

document.addEventListener("DOMContentLoaded", () => {
  instruments.forEach(inst => createRow(inst));
  document.querySelectorAll('.drag-item').forEach(item => {
    item.addEventListener('dragstart', e => {
      draggedRhythm = e.target.dataset.rhythm;
    });
  });
  document.getElementById("clear-btn").addEventListener("click", () => {
    document.querySelectorAll(".cell").forEach(c => {
      c.classList.remove("active");
      c.innerHTML = "";
    });
    selectedDots.clear();
  });
});
</script>
</body>
</html>
